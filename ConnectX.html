<!DOCTYPE html>
<html>
<head>
    <title>Connect X - web Beta</title>
    <style>
        .board {
            display: flex;
            flex-wrap: wrap;
            width: 420px;
            margin: 0 auto;
        }

        .cell {
            width: 60px;
            height: 60px;
            background-color: lightblue;
            border: 1px solid white;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <h1>Connect X - web Beta</h1>
    <div class="board"></div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Game Constants
        const ROWS = 6;
        const COLS = 7;
        const PLAYER1_COLOR = 'red';
        const PLAYER2_COLOR = 'yellow';
        const sleep = async (ms) => {
            return new Promise(
                (resolve, reject) =>
                setTimeout(
                    () => resolve(),
                    ms * 1000
                    )
                );
        };

        let board = [];
        let currentPlayer = 1;

        // Create the game board
        const boardElement = document.querySelector('.board');
        for (let row = 0; row < ROWS; row++) {
            for (let col = 0; col < COLS; col++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.setAttribute('data-row', row);
                cell.setAttribute('data-col', col);
                boardElement.appendChild(cell);
            }
        }

        // Add event listener to cells
        const cells = document.querySelectorAll('.cell');
        cells.forEach(cell => cell.addEventListener('click', handleCellClick));

        async function cpu_turn() {
            var col;
            try {
                const response = await axios({
                    method: "POST",
                    url: 'http://pwnable.co.kr:10004/get_next_action/',
                    data: {
                        "list": board
                    },
                    headers: {
                        'Access-Control-Allow-Origin': '*',
                        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',
                        'Access-Control-Allow-Headers': 'Content-Type',
                        'Content-Type': 'application/json'
                    }
                });
                col = response.data; // Assuming the response contains the assigned column value
                console.log(col); // Do something with the received response
            } catch (error) {
                console.error('Error:', error);
            }

            // Find the lowest available row in the selected column
            let row = ROWS - 1;
            while (row >= 0 && board[row][col]) {
                row--;
            }

            // Fall all the way down if there is no stone underneath
            if (row < 0) {
                row = 0;
                while (row < ROWS && board[row][col]) {
                    row++;
                }
            }

            // Update the game board
            board[row][col] = currentPlayer;

            // Update the cell color
            const color = currentPlayer === 1 ? PLAYER1_COLOR : PLAYER2_COLOR;
            //clickedCell.style.backgroundColor = color;


            // Reflect the changes on the screen
            const rowCell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            rowCell.style.backgroundColor = color;
            await sleep(0.3);

            // Check for a win
            if (checkWin(row, col)) {
                const winner = currentPlayer === 1 ? 'Player 1' : 'Player 2';
                alert(`${winner} wins!`);
                resetGame();
                return;
            }

            // Switch players
            currentPlayer = currentPlayer === 1 ? 2 : 1;
        }

        // Handle cell click event
        async function handleCellClick(e) {
            const clickedCell = e.target;
            const col = parseInt(clickedCell.getAttribute('data-col'));

            // Find the lowest available row in the selected column
            let row = ROWS - 1;
            while (row >= 0 && board[row][col]) {
                row--;
            }

            // Fall all the way down if there is no stone underneath
            if (row < 0) {
                row = 0;
                while (row < ROWS && board[row][col]) {
                    row++;
                }
            }

            // Update the game board
            board[row][col] = currentPlayer;

            // Update the cell color
            const color = currentPlayer === 1 ? PLAYER1_COLOR : PLAYER2_COLOR;
            //clickedCell.style.backgroundColor = color;

            // Reflect the changes on the screen
            const rowCell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            rowCell.style.backgroundColor = color;
            //setTimeout(() => {}, 1000);
            await sleep(0.5);

            // Check for a win
            if (checkWin(row, col)) {
                const winner = currentPlayer === 1 ? 'Player 1' : 'Player 2';
                alert(`${winner} wins!`);
                resetGame();
                return;
            }

            // Switch players
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            cpu_turn();
        }


        // Check for a win
        function checkWin(row, col) {
            const color = currentPlayer === 1 ? PLAYER1_COLOR : PLAYER2_COLOR;

            // Check for horizontal win
            let count = 0;
            let startCol = Math.max(0, col - 3);
            let endCol = Math.min(COLS - 1, col + 3);
            for (let i = startCol; i <= endCol; i++) {
                if (board[row][i] === currentPlayer) {
                    count++;
                    if (count === 4) {
                        return true;
                    }
                } else {
                    count = 0;
                }
            }

            // Check for vertical win
            count = 0;
            let startRow = Math.max(0, row - 3);
            let endRow = Math.min(ROWS - 1, row + 3);
            for (let i = startRow; i <= endRow; i++) {
                if (board[i][col] === currentPlayer) {
                    count++;
                    if (count === 4) {
                        return true;
                    }
                } else {
                    count = 0;
                }
            }

            // Check for diagonal win (top-left to bottom-right)
            count = 0;
            let startDiagRow = Math.max(0, row - 3);
            let startDiagCol = Math.max(0, col - 3);
            let endDiagRow = Math.min(ROWS - 1, row + 3);
            let endDiagCol = Math.min(COLS - 1, col + 3);
            let r = startDiagRow;
            let c = startDiagCol;
            while (r <= endDiagRow && c <= endDiagCol) {
                if (board[r][c] === currentPlayer) {
                    count++;
                    if (count === 4) {
                        return true;
                    }
                } else {
                    count = 0;
                }
                r++;
                c++;
            }

            // Check for diagonal win (top-right to bottom-left)
            count = 0;
            startDiagRow = Math.max(0, row - 3);
            startDiagCol = Math.min(COLS - 1, col + 3);
            endDiagRow = Math.min(ROWS - 1, row + 3);
            endDiagCol = Math.max(0, col - 3);
            r = startDiagRow;
            c = startDiagCol;
            while (r <= endDiagRow && c >= endDiagCol) {
                if (board[r][c] === currentPlayer) {
                    count++;
                    if (count === 4) {
                        return true;
                    }
                } else {
                    count = 0;
                }
                r++;
                c--;
            }

            return false;
        }

        // Reset the game
        function resetGame() {
            board = [];
            currentPlayer = 1;

            cells.forEach(cell => {
                cell.style.backgroundColor = 'lightblue';
            });
            location.reload()
        }

        // Initialize the game board
        function initializeBoard() {
            for (let row = 0; row < ROWS; row++) {
                board[row] = [];
                for (let col = 0; col < COLS; col++) {
                    board[row][col] = 0;
                }
            }
        }

        initializeBoard();
    </script>
</body>
</html>

